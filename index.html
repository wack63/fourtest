<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>兌換活動系統</title>
</head>
<body>
  <div id="login">
    <h2>登入</h2>
    <label>
      請輸入手機號碼：
      <input type="text" id="username" placeholder="例如：0912345678" maxlength="10" />
    </label>
    <button onclick="handleLogin()">登入</button>
  </div>

  <div id="app" style="display: none;">
    <h2>兌換活動</h2>
    <p id="userInfo"></p>

    <label>
      <input type="text" id="name" placeholder="輸入姓名" />
      <button onclick="redeem()">立即兌換</button>
    </label>

    <!-- <h3>今日兌換紀錄</h3>
    <ul id="todayList"></ul>

    <h3>查詢歷史紀錄</h3>
    <label>
      查詢日期（MMDD，例如0414）：
      <input type="text" id="queryDate" maxlength="4" placeholder="輸入如0414" />
    </label>
    <button onclick="queryHistory()">查詢日期紀錄</button>
    <div id="history" style="display: none;">
      <ul id="historyList"></ul>
    </div>
  </div>

  <script>
    const SHEET_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyAjl1yLNeCbH0qdtFQONSo3TMilnUzBWPIZ-CU1S-7nTVR3oJ8saGbg-DKgy-zIqoL/exec';

    const dailyLimits = {
      "0414": 25,
      "0415": 25,
      "0416": 20,
      "0417": 10,
    };

    function handleLogin() {
      const username = document.getElementById("username").value.trim();
      if (/^09\d{8}$/.test(username)) {
        localStorage.setItem("loggedInUser", username);
        const loginTime = new Date().toLocaleString();
        localStorage.setItem("loginTime", loginTime);

        fetch(SHEET_WEB_APP_URL, {
          method: "POST",
          mode: "no-cors",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            type: "login",
            phone: username,
            time: loginTime,
          }),
        });

        document.getElementById("login").style.display = "none";
        document.getElementById("app").style.display = "block";
        document.getElementById("userInfo").innerText = `已登入：${username}`;
        updateHistory();
      } else {
        alert("請輸入正確的手機號碼（例如0912345678）");
      }
    }

    function getTodayKey() {
      const today = new Date();
      const mm = String(today.getMonth() + 1).padStart(2, "0");
      const dd = String(today.getDate()).padStart(2, "0");
      return mm + dd;
    }

    function updateHistory() {
      const todayKey = getTodayKey();
      const localData = JSON.parse(localStorage.getItem("voucherData") || "[]");
      const todayData = localData.filter(r => r.date === todayKey);

      const list = document.getElementById("todayList");
      list.innerHTML = "";
      todayData.forEach(record => {
        const li = document.createElement("li");
        li.textContent = `${record.time} - ${record.name} (${record.phone})`;
        list.appendChild(li);
      });
    }

    function redeem() {
      const name = document.getElementById("name").value.trim();
      const phone = localStorage.getItem("loggedInUser");
      if (!name) {
        alert("請輸入姓名");
        return;
      }

      const todayKey = getTodayKey();
      const localData = JSON.parse(localStorage.getItem("voucherData") || "[]");

      const isDuplicate = localData.some(r => r.phone === phone);
      if (isDuplicate) {
        alert("此手機號碼已兌換過，無法重複兌換");
        return;
      }

      const todayData = localData.filter(r => r.date === todayKey);
      const limit = dailyLimits[todayKey] || 0;
      if (todayData.length >= limit) {
        alert("今日兌換名額已滿");
        return;
      }

      const now = new Date();
      const record = {
        name,
        phone,
        date: todayKey,
        time: now.toLocaleTimeString(),
      };
      localData.push(record);
      localStorage.setItem("voucherData", JSON.stringify(localData));
      updateHistory();

      fetch(SHEET_WEB_APP_URL, {
        method: "POST",
        mode: "no-cors",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          type: "redeem",
          name,
          phone,
          date: todayKey,
          time: now.toLocaleTimeString(),
        }),
      });

      alert("兌換成功！");
    }

    function queryHistory() {
      const query = document.getElementById("queryDate").value.trim();
      if (!/^\d{4}$/.test(query)) {
        alert("請輸入正確格式，例如 0414");
        return;
      }

      const formattedDate = query;
      const localData = JSON.parse(localStorage.getItem("voucherData") || "[]");
      const records = localData.filter(r => r.date === formattedDate);

      const historyList = document.getElementById("historyList");
      historyList.innerHTML = "";

      if (records.length === 0) {
        historyList.innerHTML = `<li>該日(${formattedDate})無兌換紀錄</li>`;
      } else {
        records.forEach(record => {
          const li = document.createElement("li");
          li.textContent = `${record.time} - ${record.name} (${record.phone})`;
          historyList.appendChild(li);
        });
      }

      document.getElementById("history").style.display = "block";
    }
  </script>
</body>
</html>
